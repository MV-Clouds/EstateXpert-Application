<template>
    <div class="wrapper">
        <div class="header">
            <article class="slds-card">
                <div class="slds-card__header slds-grid">
                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                        <div class="slds-media__figure">
                            <lightning-icon icon-name="standard:account" alternative-text="Account" title="Account"></lightning-icon>
                        </div>
                        <div class="slds-media__body">
                            <p class="blur-text">Email Campaign Template</p>
                            <div class="header-text">New Email Campaign Template</div>
                        </div>
                    </header>
                </div>
            </article>
        </div>

        <div class="container">
            <div class="content-header">
                New Email Campaign Template
            </div>

            <div class="content-body">
                <div class="content">
                    <div class="content-details">
                        <p class="content-text">Email Campaign Template :</p>
                        <span class="content-data">{emailCampaignTemplate}</span>
                    </div>
                    <div class="content-details">
                        <p class="content-text">Email Campaign Name :</p>
                        <span class="content-data">{emailCampaignName}</span>
                    </div>
                </div>
                <div class="edit-btn">
                    <button class="slds-button slds-button_icon slds-button_icon-border-filled edit" onclick={handleEdit}>
                        <lightning-icon icon-name="utility:edit" alternative-text="Edit" size="small"></lightning-icon>
                    </button>
                </div>
            </div>

            <div class="dotted-border"></div>

            <div class="contact-input-fields">

            <!-- Primary Recipients -->
            <div class="primary-recipients input-field">
                <lightning-input
                    label="Select the primary recipient(s)"
                    placeholder="Type to search contacts"
                    onchange={handlePrimarySearchInputChange}
                    onfocus={handlePrimarySearchInputFocus}
                    onblur={handlePrimarySearchInputBlur}
                    value={inputValuePrimary}
                ></lightning-input>

                <template if:true={isPrimaryDropdownVisible}>
                    <div class="dropdown">
                        <template for:each={filteredPrimaryContacts} for:item="contact">
                            <div key={contact.value} class="dropdown-item" onclick={handleSelectPrimaryContact} data-id={contact.value}>
                                <span class="slds-icon_container slds-icon-standard-account" title="Account">
                                    <lightning-icon icon-name="standard:account" alternative-text="Account" title="Account"></lightning-icon>
                                </span>
                                <span class="container-pill-label">{contact.label}</span>
                            </div>
                        </template>
                    </div>
                </template>

                <div class="slds-pill_container" if:true={selectedPrimaryRecipients.length}>
                    <template for:each={selectedPrimaryRecipients} for:item="recipient">
                        <span key={recipient.value} class="slds-pill" title={recipient.label}>
                            <span class="slds-icon_container slds-icon-standard-account" title="Account">
                                <lightning-icon icon-name="standard:account" alternative-text="Account"></lightning-icon>
                            </span>
                            <span class="slds-pill__label">{recipient.label}</span>
                            <button class="slds-button slds-button_icon slds-pill__remove" title="Remove" data-id={recipient.value} onclick={removePrimaryRecipient}>
                                <lightning-icon icon-name="utility:close" alternative-text="Remove"></lightning-icon>
                                <span class="slds-assistive-text">Remove</span>
                            </button>
                        </span>
                    </template>
                </div>
            </div>

            <!-- CC Recipients -->
            <div class="input-field">
                <lightning-input
                    label="Who should be CC'd?"
                    placeholder="Type to search contacts"
                    onchange={handleCCSearchInputChange}
                    onfocus={handleCCSearchInputFocus}
                    onblur={handleCCSearchInputBlur}
                    value={inputValueCC}
                ></lightning-input>

                <template if:true={isCCDropdownVisible}>
                    <div class="dropdown">
                        <template for:each={filteredCCContacts} for:item="contact">
                            <div key={contact.value} class="dropdown-item" onclick={handleSelectCCContact} data-id={contact.value}>
                                <span class="slds-icon_container slds-icon-standard-account" title="Account">
                                    <lightning-icon icon-name="standard:account" alternative-text="Account" title="Account"></lightning-icon>
                                </span>
                                <span class="container-pill-label">{contact.label}</span>
                            </div>
                        </template>
                    </div>
                </template>

                <div class="slds-pill_container" if:true={selectedCCRecipients.length}>
                    <template for:each={selectedCCRecipients} for:item="recipient">
                        <span key={recipient.value} class="slds-pill" title={recipient.label}>
                            <span class="slds-icon_container slds-icon-standard-account" title="Account">
                                <lightning-icon icon-name="standard:account" alternative-text="Account"></lightning-icon>
                            </span>
                            <span class="slds-pill__label">{recipient.label}</span>
                            <button class="slds-button slds-button_icon slds-pill__remove" title="Remove" data-id={recipient.value} onclick={removeCCRecipient}>
                                <lightning-icon icon-name="utility:close" alternative-text="Remove"></lightning-icon>
                                <span class="slds-assistive-text">Remove</span>
                            </button>
                        </span>
                    </template>
                </div>
            </div>

            <!-- BCC Recipients -->
            <div class="input-field">
                <lightning-input
                    label="Who should be BCC'd?"
                    placeholder="Type to search contacts"
                    onchange={handleBCCSearchInputChange}
                    onfocus={handleBCCSearchInputFocus}
                    onblur={handleBCCSearchInputBlur}
                    value={inputValueBcc}
                ></lightning-input>

                <template if:true={isBCCDropdownVisible}>
                    <div class="dropdown">
                        <template for:each={filteredBCCContacts} for:item="contact">
                            <div key={contact.value} class="dropdown-item" onclick={handleSelectBCCContact} data-id={contact.value}>
                                <span class="slds-icon_container slds-icon-standard-account" title="Account">
                                    <lightning-icon icon-name="standard:account" alternative-text="Account" title="Account"></lightning-icon>
                                </span>
                                <span class="container-pill-label">{contact.label}</span>
                            </div>
                        </template>
                    </div>
                </template>

                <div class="slds-pill_container" if:true={selectedBCCRecipients.length}>
                    <template for:each={selectedBCCRecipients} for:item="recipient">
                        <span key={recipient.value} class="slds-pill" title={recipient.label}>
                            <span class="slds-icon_container slds-icon-standard-account" title="Account">
                                <lightning-icon icon-name="standard:account" alternative-text="Account"></lightning-icon>
                            </span>
                            <span class="slds-pill__label">{recipient.label}</span>
                            <button class="slds-button slds-button_icon slds-pill__remove" title="Remove" data-id={recipient.value} onclick={removeBCCRecipient}>
                                <lightning-icon icon-name="utility:close" alternative-text="Remove"></lightning-icon>
                                <span class="slds-assistive-text">Remove</span>
                            </button>
                        </span>
                    </template>
                </div>
            </div>
            </div>
    
            <div class="slds-form-element slds-m-top_medium input-date-container">
                <lightning-input class="input-date slds-m-top_small" label="Select a date field" placeholder="Choose a date" type="date" value={specificDate} onchange={handleSpecificDateChange}></lightning-input>
            </div>

            <template if:true={emails}>
                <div class="table-container">
                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-m-top_medium">
                        <thead>
                            <tr class="slds-line-height_reset">

                                <th scope="col">
                                    <div class="slds-truncate" title="Email Name">Email Name</div>
                                </th>

                                <th scope="col">
                                    <div class="slds-truncate" title="Email Template">Email Template</div>
                                </th>
                                <th scope="col">
                                    <div class="slds-truncate" title="Subject">Subject</div>
                                </th>
                                <th scope="col">
                                    <div class="slds-truncate" title="Days after start date">Days after start date</div>
                                </th>
                                <th scope="col">
                                    <div class="slds-truncate" title="Time to send">Time to send</div>
                                </th>

                                <th scope="col">
                                    <div class="slds-truncate" title="Exact Date"> Exact Date</div>
                                </th>
                                <th scope="col">
                                    <div class="slds-truncate" title="Action">Action</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template for:each={emails} for:item="email">
                                <tr key={email.id}>
                                    <td data-label="Email Name">
                                        <div>
                                            <lightning-input
                                                type="text"
                                                value={email.name}
                                                onchange={handleNameChange}
                                                data-id={email.id}
                                            ></lightning-input>
                                        </div>
                                    </td>
                                    <td data-label="Email Template">
                                        <div>
                                            <lightning-combobox 
                                                name="emailName"
                                                value={email.template}
                                                options={quickTemplateOptions}
                                                onchange={handleTemplateChange}
                                                data-id={email.id}
                                            ></lightning-combobox>
                                        </div>
                                    </td>
                                    <td data-label="Subject">
                                        <div>
                                            <lightning-input
                                                type="text"
                                                value={email.subject}
                                                disabled
                                                class="slds-truncate"
                                                title={email.subject}
                                            ></lightning-input>
                                        </div>
                                    </td>
                                    <td data-label="Days after start date">
                                        <div>
                                            <lightning-input
                                                type="number"
                                                value={email.daysAfterStartDate}
                                                onchange={handleDaysAfterStartDateChange}
                                                data-id={email.id}
                                            ></lightning-input>
                                        </div>
                                    </td>
                                    <td data-label="Time to send">
                                        <div>
                                            <lightning-input
                                                type="time"
                                                value={newDate}
                                                onchange={handleTimeToSendChange}
                                                data-id={email.id}
                                            ></lightning-input>
                                        </div>
                                    </td>
                                    <td data-label="Exact Date">
                                        <div>
                                            <lightning-input type="date" value={email.exactDate} data-id={email.id} disabled></lightning-input>
                                        </div>
                                    </td>

                                    <td data-label="Action" class="actions">
                                        <div class="action-btns">
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" aria-pressed="false" data-id={email.id} onclick={handlepreviewBtn}>
                                                <img src={previewBtnUrl} alt="previewBtn">
                                            </button>
                                            <button class="slds-button slds-button_icon slds-button_icon-border-filled" aria-pressed="false" data-id={email.id} onclick={handleDeleteEmail}>
                                                <img src={deleteBtnUrl} alt="deleteBtn">
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

            </template>


            <div class="slds-m-top_medium add-btn">
                <lightning-button label="+ Add New Email" onclick={handleAddNewEmail}></lightning-button>
            </div>

            <div class="footer-btns">
                <div class="footer">
                    <lightning-button label="Cancel" onclick={handleCancel}></lightning-button>
                    <lightning-button label="Save" variant="brand" onclick={handleSave}></lightning-button>    
                </div>
            </div>
        </div>

        <c-email-campaign-modal if:true={isModalOpen} form-data={navigationStateString} onclose={handleModalClose} selected-template-id={templateId} onhandledatachange={handleTemplateDataChange}> </c-email-campaign-modal>

    </div>
    
</template>